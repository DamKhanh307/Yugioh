<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Yu-Gi-Oh! Mini — Full Duel</title>
<style>
:root{--bg:#071022;--panel:#0f1724;--muted:#9fb0c6;--accent:#ffd166}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#071022,#07172a);color:#e6eef8;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
.app{max-width:1200px;margin:18px auto;padding:14px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.h1{font-size:20px}
.btn{background:#134a5b;border:none;padding:8px 10px;border-radius:6px;color:#fff;cursor:pointer}
.btn.primary{background:var(--accent);color:#071022;font-weight:700}
.row{display:flex;gap:12px;align-items:flex-start}
.col{background:var(--panel);padding:12px;border-radius:8px;flex:1}
.small{font-size:12px;color:var(--muted)}
.card-grid{display:flex;flex-wrap:wrap;gap:8px;max-height:56vh;overflow:auto;padding:6px}
.card-item{width:110px;background:#091723;border-radius:8px;padding:6px;cursor:pointer;border:2px solid transparent}
.card-item.selected{border-color:#27c4ff}
.card-item img{width:100%;height:72px;object-fit:cover;border-radius:4px}
.controls{display:flex;gap:8px;align-items:center;margin-top:8px}
.alert{color:#ffdede}
.hidden{display:none}

/* Duel field layout */
.field-wrap{display:grid;grid-template-rows:auto 1fr auto;gap:8px}
.field-top{display:flex;justify-content:space-between;gap:12px}
.panel-center{display:flex;gap:12px;align-items:center;justify-content:center}
.zones{display:flex;gap:10px}
.zone{width:120px;height:140px;border-radius:8px;border:2px dashed rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#07182a,#052734);position:relative;color:var(--muted);overflow:hidden}
.zone.empty::after{content:"Empty";position:absolute;bottom:6px;left:6px;font-size:11px;color:var(--muted)}
.zone .card{width:100px;height:120px;border-radius:6px;background:#111;padding:6px;display:flex;flex-direction:column;justify-content:space-between;font-size:12px;color:#fff}
.zone .card img{width:100%;height:70px;object-fit:cover;border-radius:4px}
.hand{display:flex;gap:8px;padding:10px;overflow:auto;background:linear-gradient(180deg,#021320,#05202a);border-radius:8px}
.hand .hand-card{width:120px;height:170px;border-radius:8px;background:#0b2b35;cursor:grab;flex:0 0 auto;position:relative}
.hand .hand-card img{width:100%;height:110px;object-fit:cover;border-radius:6px}
.log{max-height:160px;overflow:auto;background:rgba(255,255,255,0.02);padding:8px;border-radius:6px;color:var(--muted);font-size:13px}

.badge{background:#0d2a36;color:#9fe6ff;padding:6px 8px;border-radius:6px;font-weight:700}
.footer-controls{display:flex;gap:8px;align-items:center;margin-top:8px}
.info-box{font-size:13px;color:var(--muted)}
.grave-box{width:200px;height:120px;border-radius:8px;background:linear-gradient(180deg,#071224,#02121a);display:flex;flex-direction:column;align-items:center;justify-content:center}
#oppInfo:hover { background: rgba(255, 255, 255, 0.05); border-color: rgba(255, 255, 255, 0.1); }
/* Card face-down visual */
.zone .card.facedown img {
    filter: brightness(0);
    border: 2px solid #555;
}
.zone .card.facedown::after {
    content: "SET";
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    color: #fff;
    font-weight: bold;
    pointer-events: none;
}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="h1">Yu-Gi-Oh! Mini — Full Duel (deck select → duel)</div>
    <div class="small">Tip: run with a local server to avoid CORS issues</div>
  </div>

  <!-- SCREEN: deck select -->
  <div id="screen-deck" class="">
    <div class="row">
      <div class="col" style="flex:2">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">Search YGOPRODeck API</div>
            <div style="margin-top:6px">
              <input id="searchInput" placeholder="Enter card name (ex: Dark Magician)" style="width:60%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff"/>
              <button id="btnSearch" class="btn">Search</button>
              <button id="btnRandom" class="btn">Random sample</button>
            </div>
          </div>
          <div class="info-box">
            <div>Selected deck size: <span id="deckCount">0</span>/20</div>
            <div style="margin-top:6px"><button id="btnStart" class="btn primary">Start Duel</button></div>
          </div>
        </div>

        <div style="margin-top:10px" class="card-grid" id="cardGrid">
          <!-- search results here -->
        </div>
      </div>

      <div class="col" style="flex:1">
        <div class="small">Selected deck (order preserved)</div>
        <div id="selectedDeck" class="card-grid"></div>
        <div class="controls"><button id="clearDeck" class="btn">Clear</button> <div class="small" style="margin-left:6px">Tip: choose up to 20 cards</div></div>
        <div style="margin-top:12px" class="small">Quick guide: search name → click card to add to deck → Start Duel</div>
      </div>
    </div>
  </div>

  <!-- SCREEN: duel -->
  <div id="screen-duel" class="hidden" style="margin-top:12px">
    <div class="field-wrap">
      <div class="field-top">
        <div class="col" style="flex:3">
  <div id="oppInfo" style="display:flex;justify-content:space-between;align-items:center; cursor:pointer; border:1px solid transparent; padding:4px; border-radius:4px; transition:0.2s">
    <div>
      <div class="small">Opponent (Click to Attack Direct)</div>
      <div style="font-weight:700">LP: <span id="oppLP">8000</span></div>
    </div>
    <div class="badge" id="turnBadge">YOUR TURN</div>
    <div class="small">Deck: <span id="oppDeckCnt">20</span> • Grave: <span id="oppGraveCnt">0</span></div>
  </div>

          <div style="margin-top:8px">
            <div class="small">Spell/Trap Zone</div>
            <div class="zones" id="oppST"></div>

            <div style="height:8px"></div>
            <div class="small">Monster Zone</div>
            <div class="zones" id="oppMZ"></div>
          </div>
        </div>

        <div class="col" style="flex:1">
          <div class="small">Opponent Grave</div>
          <div class="grave-box" id="oppGraveBox"><div id="oppGraveTop">—</div><div class="small" id="oppGraveNum">0 cards</div></div>
        </div>
      </div>

      <div class="panel-center">
        <div style="width:60%" class="col">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small">You</div>
              <div style="font-weight:700">LP: <span id="plLP">8000</span></div>
            </div>
            <div class="small">Deck: <span id="plDeckCnt">20</span> • Grave: <span id="plGraveCnt">0</span></div>
            <div class="small">Phase: <span id="phaseName">MAIN</span></div>
            <div class="small">Selected: <span id="selectedInfo">—</span></div>
          </div>

          <div style="margin-top:8px">
            <div class="small">Monster Zone</div>
            <div class="zones" id="plMZ"></div>

            <div style="height:8px"></div>
            <div class="small">Spell/Trap Zone</div>
            <div class="zones" id="plST"></div>
          </div>
        </div>

        <div style="width:300px" class="col">
          <div class="small">Your Grave</div>
          <div class="grave-box" id="plGraveBox"><div id="plGraveTop">—</div><div class="small" id="plGraveNum">0 cards</div></div>

          <div style="margin-top:10px" class="small">Controls</div>
          <div class="footer-controls">
            <button id="btnDraw" class="btn">Draw</button>
            <button id="btnEnd" class="btn primary">End Turn</button>
            <button id="btnToBattle" class="btn">Go Battle</button>
          </div>

          <div style="margin-top:10px">
            <div class="small">Log</div>
            <div class="log" id="log"></div>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="small">Your Hand</div>
        <div class="hand" id="hand"></div>
        <div style="margin-top:8px" class="small">Drag card from hand → drop to Monster Zone (summon) or Spell/Trap Zone (set).</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===========================
   Config & utils
   =========================== */
const API_BASE = 'https://db.ygoprodeck.com/api/v7/cardinfo.php?name=';
const MAX_DECK = 20;
const logEl = id('log');

function id(x){return document.getElementById(x)}
function el(tag,cls){const d=document.createElement(tag); if(cls) d.className=cls; return d}
function log(msg){ const now = new Date().toLocaleTimeString(); id('log').innerHTML = `<div>[${now}] ${msg}</div>` + id('log').innerHTML }

/* Mẫu Hiệu Ứng*/
const cardEffects = {
  "Raigeki": (who) => {
    const targetField = who==='player' ? opp.field : player.field;
    const targetGrave = who==='player' ? opp.grave : player.grave;
    let count = 0;
    for(let i=0; i<5; i++){
      if(targetField[i]) {
        targetGrave.push(targetField[i]);
        targetField[i] = null;
        count++;
      }
    }
    return `Đã tiêu diệt ${count} quái thú của đối phương!`;
  },
  "Dian Keto the Cure Master": (who) => {
    if(who==='player') player.lp += 1000; else opp.lp += 1000;
    return "Hồi phục 1000 LP.";
  },
  "Ookazi": (who) => {
    if(who==='player') opp.lp -= 800; else player.lp -= 800;
    return "Gây 800 sát thương cho đối thủ.";
  },
  "Pot of Greed": (who) => {
    drawCard(who);
    drawCard(who);
    return "Rút 2 lá bài.";
  },
  "Dark Hole": (who) => {
    [player, opp].forEach(p => {
      for(let i=0; i<5; i++){
        if(p.field[i]){ p.grave.push(p.field[i]); p.field[i] = null; }
      }
    });
    return "Đã tiêu diệt toàn bộ quái thú trên sân!";
  }
};
/* ===========================
   App state
   =========================== */
let chosenDeck = [];
let player = { lp:8000, deck:[], hand:[], field:[null,null,null,null,null], st:[null,null,null,null,null], grave:[] }
let opp = { lp:8000, deck:[], hand:[], field:[null,null,null,null,null], st:[null,null,null,null,null], grave:[] }
let state = { turn:'player', phase:'MAIN', selected:null, started:false }

/* ===========================
   Deck select screen logic
   =========================== */
const cardGrid = id('cardGrid'), selectedDeckEl = id('selectedDeck'), deckCountEl = id('deckCount')
id('btnSearch').onclick = async () => {
  const q = document.getElementById('searchInput').value.trim()
  if(!q) return alert('Nhập tên bài để search')
  await searchAndShow(q)
}
id('btnRandom').onclick = ()=> {
  const samples = [
    {id:'c1',name:'Dark Magician',atk:2500,def:2100,level:7,image:'https://images.ygoprodeck.com/images/cards/46986414.jpg'},
    {id:'c2',name:'Blue-Eyes White Dragon',atk:3000,def:2500,level:8,image:'https://images.ygoprodeck.com/images/cards/89631139.jpg'},
    {id:'c3',name:'Kuriboh',atk:300,def:200,level:1,image:'https://images.ygoprodeck.com/images/cards/40640057.jpg'}
  ]
  renderCardResults(samples)
}
id('clearDeck').onclick = ()=> { chosenDeck=[]; renderSelectedDeck(); }
id('btnStart').onclick = ()=> {
  if(chosenDeck.length < 5) return alert('Chọn ít nhất 5 lá để duel (demo)')
  startDuel()
}

async function searchAndShow(name){
  cardGrid.innerHTML = '<div class="small">Searching...</div>'
  try{
    const res = await fetch(API_BASE + encodeURIComponent(name))
    if(!res.ok) throw new Error('API error: ' + res.status)
    const j = await res.json()
    if(!j.data || j.data.length===0) { cardGrid.innerHTML = '<div class="small">Không tìm thấy</div>'; return }
    const results = j.data.map(c=>({
      id: c.id || c.name,
      name: c.name,
      atk: c.atk || 0,
      def: c.def || 0,
      level: c.level || 0,
      image: (c.card_images && c.card_images[0] && c.card_images[0].image_url) ? c.card_images[0].image_url : null,
      raw: c
    }))
    renderCardResults(results)
  }catch(err){
    console.error(err)
    cardGrid.innerHTML = '<div class="small alert">API lỗi hoặc bị CORS — thử Random sample</div>'
  }
}

function renderCardResults(arr){
  cardGrid.innerHTML = ''
  arr.forEach(card=>{
    const div = el('div','card-item')
    const img = el('img'); img.src = card.image || ''; div.appendChild(img)
    const nm = el('div'); nm.textContent = card.name; nm.className='small'; nm.style.marginTop='6px'
    div.appendChild(nm)
    div.onclick = ()=>{
      if(chosenDeck.length >= MAX_DECK) return alert('Đã đủ 20 lá')
      const clone = {...card, uid: card.id + '-' + Math.random().toString(36).slice(2,8)}
      chosenDeck.push(clone)
      renderSelectedDeck()
    }
    cardGrid.appendChild(div)
  })
}

function renderSelectedDeck(){
  selectedDeckEl.innerHTML = ''
  chosenDeck.forEach((c,i)=>{
    const d = el('div','card-item')
    const img = el('img'); img.src = c.image || ''; d.appendChild(img)
    const nm = el('div'); nm.textContent = c.name; nm.className='small'; nm.style.marginTop='6px'
    d.appendChild(nm)
    const btn = el('button'); btn.textContent='Remove'; btn.className='btn'; btn.style.marginTop='6px'
    btn.onclick = ()=>{ chosenDeck.splice(i,1); renderSelectedDeck() }
    d.appendChild(btn)
    selectedDeckEl.appendChild(d)
  })
  deckCountEl.textContent = chosenDeck.length
}

/* ===========================
   Start duel: init players, shuffle, draw 5
   =========================== */
function startDuel(){
  player.deck = chosenDeck.map(c=> ({...c, uid: c.uid}) )
  shuffle(player.deck)
  opp.deck = player.deck.map(c=> ({...c, uid: c.uid+'-opp'}))
  shuffle(opp.deck)
  player.hand = []; player.field = [null,0,null,null,null]; player.st=[null,null,null,null,null]; player.grave=[]
  opp.hand=[]; opp.field=[null,null,null,null,null]; opp.st=[null,null,null,null,null]; opp.grave=[]
  player.lp=8000; opp.lp=8000; state.turn='player'; state.phase='MAIN'; state.selected=null; state.started=true

  // UI switch
  document.getElementById('screen-deck').classList.add('hidden')
  document.getElementById('screen-duel').classList.remove('hidden')

  // initial draws
  for(let i=0;i<5;i++){ drawCard('player',false); drawCard('opp',false) }
  renderAll()
  log('Duel started. You draw 5. Your turn.')
}

/* ===========================
   Draw / UI rendering
   =========================== */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } }
function drawCard(who, showLog=true){
  const P = who==='player'?player:opp
  if(P.deck.length===0){ if(who==='player') log('Bạn không còn bài để rút'); return null }
  const c = P.deck.pop()
  P.hand.push(c)
  if(showLog) log((who==='player'?'Bạn':'Opponent') + ' rút 1 bài.')
  renderAll()
  return c
}

function renderAll(){
  // LPs and counts
  id('plLP').textContent = player.lp; id('oppLP').textContent = opp.lp
  id('plDeckCnt').textContent = player.deck.length; id('oppDeckCnt').textContent = opp.deck.length
  id('plGraveCnt').textContent = player.grave.length; id('oppGraveCnt').textContent = opp.grave.length
  id('plGraveNum').textContent = player.grave.length + ' cards'; id('oppGraveNum').textContent = opp.grave.length + ' cards'
  id('plGraveTop').textContent = player.grave.length ? player.grave[player.grave.length-1].name : '—'
  id('oppGraveTop').textContent = opp.grave.length ? opp.grave[opp.grave.length-1].name : '—'
  id('phaseName').textContent = state.phase
  id('turnBadge').textContent = state.turn === 'player'? 'YOUR TURN':'OPP TURN'
  id('selectedInfo').textContent = state.selected ? (state.selected.name || state.selected.uid) : '—'

  // render zones
  renderZones('plMZ', player.field, 'player','mz')
  renderZones('plST', player.st, 'player','st')
  renderZones('oppMZ', opp.field, 'opp','mz')
  renderZones('oppST', opp.st, 'opp','st')

  // hand
  const handEl = id('hand'); handEl.innerHTML = ''
  player.hand.forEach((c,idx)=>{
    const card = el('div','hand-card'); card.draggable=true
    card.dataset.uid = c.uid
    const img = el('img'); img.src = c.image || ''; card.appendChild(img)
    const nm = el('div'); nm.textContent = c.name; nm.className='small'; nm.style.padding='6px'; card.appendChild(nm)
    // drag events
    card.addEventListener('dragstart', (e)=>{
      e.dataTransfer.setData('text/plain', JSON.stringify({uid:c.uid, who:'player'}))
    })
    handEl.appendChild(card)
  })
}

/* Render zones helper */
function renderZones(containerId, arr, ownerKey, type){
  const container = id(containerId); container.innerHTML = ''
  for(let i=0;i<5;i++){
    const z = el('div','zone'); z.dataset.owner = ownerKey; z.dataset.type = type; z.dataset.idx = i
    if(arr[i]){
      const c = arr[i]
      const cardBox = el('div', 'card ' + (c.facedown ? 'facedown' : ''));
      if(c.image) { const im=el('img'); im.src=c.image; cardBox.appendChild(im) }
      const name = el('div'); name.textContent = c.name; name.style.fontSize='12px'; cardBox.appendChild(name)
if(ownerKey === 'player') {
  cardBox.onclick = (e) => {
    e.stopPropagation();
    if (type === 'mz') {
      state.selected = { uid: c.uid, owner: 'player', idx: i, name: c.name, type: type };
      log('Selected monster: ' + c.name);
      renderAll();
    }
    else if (type === 'st') {
      if (confirm(`Bạn có muốn kích hoạt lá bài "${c.name}" không?`)) {
        activateSpellTrap('player', i);
      }
    }
  }
} else {
        cardBox.onclick = (e)=>{
          e.stopPropagation()
          if(state.selected && state.selected.owner==='player' && state.selected.type==='mz'){
            attack('player', state.selected.idx, 'opp', i)
            state.selected = null
            renderAll()
          }
        }
      }
      z.appendChild(cardBox)
    } else {
      z.classList.add('empty')
    }

    z.addEventListener('dragover', (e)=> e.preventDefault())
    z.addEventListener('drop', (e)=>{
      e.preventDefault()
      if(state.turn !== 'player') { log('Không phải lượt bạn'); return }
      if(state.phase !== 'MAIN') { log('Chỉ có thể triệu hồi/đặt ở MAIN phase'); return }
      try{
        const dat = JSON.parse(e.dataTransfer.getData('text/plain'))
        if(dat.who !== 'player') return
        const cardIdx = player.hand.findIndex(x=>x.uid===dat.uid)
        if(cardIdx===-1) return
        const card = player.hand[cardIdx]
        if(type==='mz'){
          if(player.field[i]) { log('Ô đã có quái'); return }
          player.field[i] = card
          player.hand.splice(cardIdx,1)
          log('Bạn triệu hồi ' + card.name + ' lên Monster Zone #' + (i+1))
        } else { 
          if(player.st[i]) { log('Ô ST đã có bài'); return }
          const setCard = {...card, facedown:true}
          player.st[i] = setCard
          player.hand.splice(cardIdx,1)
          log('Bạn đặt 1 Spell/Trap xuống ô #' + (i+1))
        }
        renderAll()
      }catch(err){
        console.error(err)
      }
    })

    container.appendChild(z)
  }
}

/* ===========================
   Attack logic & resolution
   =========================== */
function attack(attOwner, attIdx, defOwner, defIdx){
  const attacker = (attOwner==='player')?player.field[attIdx]:opp.field[attIdx]
  const defender = (defOwner==='player')?player.field[defIdx]:opp.field[defIdx]
  if(!attacker){ log('No attacker'); return }
  if(!defender){
    // direct attack
    if(defOwner==='player'){ player.lp -= attacker.atk || 0; log('Opponent attacks directly: -' + (attacker.atk||0) + ' LP'); }
    else { opp.lp -= attacker.atk || 0; log('You attack directly: -' + (attacker.atk||0) + ' LP') }
    checkWin()
    renderAll()
    return
  }
  // compare ATK
  const aAtk = attacker.atk || 0, dAtk = defender.atk || 0
  if(aAtk > dAtk){
    const diff = aAtk - dAtk
    if(defOwner==='player'){ player.field[defIdx] = null; player.grave.push(defender); player.lp -= diff; log(attacker.name + ' destroys ' + defender.name + '. You -' + diff + ' LP') }
    else { opp.field[defIdx] = null; opp.grave.push(defender); opp.lp -= diff; log(attacker.name + ' destroys ' + defender.name + '. Opponent -' + diff + ' LP') }
  } else if(aAtk < dAtk){
    const diff = dAtk - aAtk
    if(attOwner==='player'){ player.field[attIdx] = null; player.grave.push(attacker); player.lp -= diff; log(defender.name + ' wins. You -' + diff + ' LP') }
    else { opp.field[attIdx] = null; opp.grave.push(attacker); opp.lp -= diff; log(defender.name + ' wins. Opponent -' + diff + ' LP') }
  } else {
    if(attOwner==='player'){ player.field[attIdx]=null; player.grave.push(attacker) }
    else opp.field[attIdx]=null
    if(defOwner==='player'){ player.field[defIdx]=null; player.grave.push(defender) }
    else opp.field[defIdx]=null
    if(defOwner==='player') log('Both destroyed (tie).')
    else log('Both destroyed (tie).')
  }
  checkWin()
}


function activateSpellTrap(owner, idx) {
  const p = owner==='player' ? player : opp;
  const card = p.st[idx];
  if(!card) return;
  delete card.facedown;
  let msg = "";
  if(cardEffects[card.name]) {
    msg = cardEffects[card.name](owner);
  } else {
    msg = "Đã kích hoạt (Effect chưa được lập trình).";
  }

  log(`Kích hoạt ${card.name}: ${msg}`);
  p.grave.push(card);
  p.st[idx] = null;

  // 4. Cập nhật giao diện
  checkWin();
  renderAll();
}

/* ===========================
   Turn flow & Opponent AI
   =========================== */
id('btnDraw').onclick = ()=> {
  if(state.turn !== 'player') return log('Chưa đến lượt bạn')
  drawCard('player')
}
id('btnEnd').onclick = ()=> {
  if(state.turn !== 'player') return log('Chưa đến lượt bạn')
  endPlayerTurn()
}
id('btnToBattle').onclick = ()=> {
  if(state.turn !== 'player') return log('Chưa đến lượt bạn')
  state.phase = 'BATTLE'
  log('Entro Battle Phase')
  renderAll()
}

function endPlayerTurn(){
  state.turn = 'opp'; state.phase='DRAW'; renderAll(); log('Bạn kết thúc lượt. Opponent turn.')
  setTimeout(()=> oppTurnSequence(), 800)
}

async function oppTurnSequence(){
  drawCard('opp', true)
  for(let i=0;i<5;i++){
    if(opp.field[i]==null){
      const idx = opp.hand.findIndex(c=>c.atk !== undefined)
      if(idx!==-1){
        opp.field[i] = opp.hand.splice(idx,1)[0]
        log('Opponent triệu hồi 1 quái.')
        break
      }
    }
  }
  for(let i=0;i<5;i++){
    const m = opp.field[i]
    if(!m) continue
    let targetIdx = player.field.findIndex(c=>c && (m.atk > (c.atk||0)))
    if(targetIdx === -1){
      if(player.field.every(x=>x==null)){
        attack('opp', i, 'player', null)
      } else {
        targetIdx = player.field.findIndex(c=>c!=null)
        if(targetIdx !== -1) attack('opp', i, 'player', targetIdx)
      }
    } else {
      attack('opp', i, 'player', targetIdx)
    }
  }
  state.turn = 'player'
  state.phase = 'MAIN'
  renderAll()
  log('Lượt bạn.')
}

/* ===========================
   Win check / reset
   =========================== */
function checkWin(){
  if(player.lp <= 0){ alert('Bạn thua!'); resetAll(); }
  if(opp.lp <= 0){ alert('Bạn thắng!'); resetAll(); }
}

function resetAll(){
  chosenDeck=[]; player={}; opp={}; state={}; location.reload()
}

/* ===========================
   Init UI helpers & initial render
   =========================== */
function idExists(idv){ return document.getElementById(idv) !== null }
function setupZonesEmpty(){
  ['plMZ','plST','oppMZ','oppST'].forEach(idv=>{
    const node = document.getElementById(idv)
    if(node) node.innerHTML = ''
    for(let i=0;i<5;i++){
    }
  })
}

/* ===========================
   CƠ CHẾ TẤN CÔNG TRỰC TIẾP
   =========================== */
if(id('oppInfo')){
  id('oppInfo').onclick = function() {
    if(!state.selected || state.selected.owner !== 'player' || state.selected.type !== 'mz') return;

    if(state.turn !== 'player') { log('Không phải lượt của bạn'); return; }
    if(state.phase !== 'BATTLE') { log('Phải vào Battle Phase mới được tấn công'); return; }

    const hasMonster = opp.field.some(card => card !== null);
    
    if(hasMonster) {
      log('Đối phương còn quái thú, phải tiêu diệt quái trước!');
      return; 
    }
    attack('player', state.selected.idx, 'opp', -1);

    state.selected = null;
    renderAll();
  };
}
renderAll()
log('Ready. Build deck then Start Duel.')

/* ===========================
   Helper: add quick logs to UI
   =========================== */
function logStart(){ log('Game ready') }

</script>
</body>
</html>
